## 数据读取与整理流程概览

目前系统的数据流采用了典型的 **ETL (Extract, Transform, Load)** 模式，通过 Streamlit 进行实时加载和处理。主要流程如下：

### 1. 数据抽取 (Extract)

系统从两类数据源读取数据：

- **MySQL 数据库 (核心业务数据)**
    - 通过 
        
        ```
        SQLAlchemy
        ```
        
         连接数据库，读取最近 **90天** 的数据。
    - **不同层级表读取**：
        - ```
            t_google_cost
            ```
            
            : 广告系列 (Campaign) 级别的基础消耗数据。
        - ```
            t_google_keyword_cost
            ```
            
            : 关键词 (Keyword) 级别的深度数据。
        - ```
            t_google_ad_cost
            ```
            
            : 广告组/广告 (Ad/Ad Group) 级别的数据（含广告状态、精准落地页）。
- **本地/云端映射文件 (配置数据)**
    - Ads_BI/mapping.xlsx: 读取 Excel 文件，获取 **账号与优化师对应关系** 以及 **广告系列与类目/落地页的映射**。
    - Ads_BI/优化师账号维度目标.csv: 优先读取该 CSV 文件，用于覆盖更新账号归属关系。

### 2. 数据清洗与转换 (Transform)

读取后，数据会在 

load_data 函数中经历清洗和逻辑处理：

- **标准化处理**：
    - **日期格式**：统一转换为 datetime 对象。
    - **数值处理**：将费用、转化数等强制转为数字，缺失值填 0。
    - **ID 清洗**：去除广告账号 ID 中的横杠等非数字字符，生成 
        
        ```
        join_id
        ```
        
         作为关联键。
    - **文本清洗**：将广告系列名称统一转为小写、去空格，确保映射匹配率。
    - **URL 清洗**：去除落地页 URL 中的 
        
        ```
        ?
        ```
        
         后缀参数，以便聚合同一页面的数据。
- **维度映射 (Mapping)**：
    - **优化师归属**：先尝试通过 
        
        ```
        Campaign ID
        ```
        
         匹配（用于拆分账号），匹配不上则回退使用 
        
        ```
        Account ID
        ```
        
         匹配优化师。
    - **业务维度**：根据广告系列名称，从映射表中匹配出 **“类目” (Category)** 和 **“最终到达网址”**。
    - **精准归因**：在关键词和广告层级，优先使用广告组级别的落地页链接，比系列级别更精准。
- **计算衍生指标**：
    - 计算每一行的 
        
        ```
        ROAS
        ```
        
         (转化价值 / 费用)。

### 3. 数据聚合与展示 (Load & Analyze)

在具体的功能模块（如“深度透视”）中，数据是**动态聚合**的：

- **筛选**：先根据侧边栏（日期、优化师、类目、账号）过滤原始数据。
- **冲突检测**：自动检测维度冲突（如由 API 限制，Google 的关键词数据不能直接与广告维度交叉），并自动切换对应的底层数据源 (
    
    ```
    final_kw_df
    ```
    
     或 
    
    ```
    final_ag_df
    ```
    
    )。
- **即时计算**：
    - 根据你勾选的维度（如“优化师+类目”），对数据进行 
        
        ```
        Group By
        ```
        
         求和。
    - **重算比率**：聚合后重新计算 ROAS、CPC、CPA、转化率等指标（即 $\frac{\sum转化价值}{\sum费用}$），而非简单对原来的 ROAS 求平均，确保数据准确。
    - **合计行**：在表格顶部生成一行 Total 数据。
